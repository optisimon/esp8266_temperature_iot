<html>

<body onload="myOnLoad()">
<H1 id="myHeader">Last Value: </H1>
<canvas id="myCanvas", width="80", height="300" style="border:1px solid #808080;">
Sorry, your browser does not support the canvas element!
</canvas>

<script src="readings.js"></script>

<script>
function myOnLoad() {
  var h = document.getElementById("myHeader");
  h.innerHTML = "Last value: " + readings[readings.length - 1].toFixed(2) +
                ". Trend for last hour:";
  var c = document.getElementById("myCanvas");
  var ctx = c.getContext("2d");

  initialize();

  function initialize() {
    window.addEventListener('resize', resizeCanvas, false);
    resizeCanvas();
    setInterval(refresh, 10000);
  }

  function redraw() {
	ctx.beginPath();
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = '5';
    ctx.strokeRect(0, 0, c.width, c.height);

	ctx.beginPath();
	ctx.lineWidth = '1';
    var scaleX = c.width * 1.0 / readings.length;
    var maxY = 50;
    var scaleY = c.height * 1.0 / maxY;
    
    
    // Make grid
    var divisionsX = 6;
    var divisionsY = 5;
    ctx.strokeStyle = "blue";
    ctx.font="100% sans-serif";
    for (var x = 0; x < divisionsX; x++)
    {
		ctx.moveTo(x * (c.width - 1) / divisionsX, 0);
		ctx.lineTo(x * (c.width - 1) / divisionsX, c.height);
	}
	for (var y = 0; y < divisionsY; y++)
	{
		ctx.moveTo(0, y * (c.height - 1) / divisionsY);
		ctx.lineTo(c.width-1, y * (c.height - 1) / divisionsY);
		ctx.strokeText(((divisionsY - y) * maxY / divisionsY).toFixed(1), 5, y * (c.height - 1) / divisionsY - 1);
	}
	ctx.stroke();
	
	ctx.beginPath();
    ctx.moveTo(0, c.height - scaleY * readings[0]);
    ctx.strokeStyle = 'black';
    ctx.lineWidth = '2';
    for (var i = 0; i < readings.length; i++) {
      ctx.lineTo(i * scaleX, c.height - scaleY * readings[i]);
    }
    ctx.stroke();
  }

  function refresh() {
   
    // TODO: fetch new fetch new json object and redraw() without reload
    //       https://www.w3schools.com/js/js_json_http.asp
    location.reload(true);
  }

  // Runs each time the DOM window resize event fires.
  // Resets the canvas dimensions to match window,
  // then draws the new borders accordingly.
  function resizeCanvas() {
    c.width = window.innerWidth - 50; // TODO: https://stackoverflow.com/questions/1664785/resize-html5-canvas-to-fit-window
    c.height = window.innerHeight - 100; // TODO: either full size, or determine absolute size somehow
    redraw();
  }

}
</script>

</body>

</html>
